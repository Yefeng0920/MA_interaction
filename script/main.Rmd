---
title: "Statistical issues in interactive effects between multiple stressors"
output: html_document
date: '2024-04-29'
---

# Set-up

```{r, warning=FALSE, echo=TRUE}
set.seed(2024)
suppressPackageStartupMessages({
  library(dplyr)
  library(readr)
  library(tidyr) 
  library(purrr)
  library(ggplot2)
  library(here)
  library(clubSandwich)  
  library(metafor)
  library(cowplot)
  library(patchwork)
  library(orchaRd)
  })

source(here("function","custom_function.R"))
```

# Original analysis by the author

## Data

```{r}
dt=read.csv(here("dat", 'OAW_interaction.csv'))
```

## Model selection

```{r}
##### 1.Generating variance-covariance matrices-------------------------------------------------
V_0.5 <- make_VCV_matrix(data = dt, V = "variance",cluster = "share_organism", 
                         obs = "Effect_size_ID", type = "vcv", rho = 0.5) 
V_0.9 <- make_VCV_matrix(data = dt, V = "variance",cluster = "share_organism", 
                         obs = "Effect_size_ID", type = "vcv", rho = 0.9)  # for sensitivity analysis

matrixcalc::is.positive.definite(V_0.5) # TRUE
matrixcalc::is.positive.definite(V_0.9) # TRUE

##### 2.Defining random effects structure----
# Effect_size_ID to estimate the residual heterogeneity,and StudyID to account for dependence between effect
# size from the same publication were always included.

## for whole dataset
RE1.dt <- rma.mv(yi = Main_effect, V = variance, 
                 random = list(~1 | StudyID, ~1 | Effect_size_ID,~1 | Species,~1 | Shared_first_author,
                               ~1 | Country), data = dt, method = "ML")
RE2.dt <- rma.mv(yi = Main_effect, V = variance, 
                 random = list(~1 | StudyID, ~1 | Effect_size_ID,~1 | Species,~1 | Shared_first_author), 
                 data = dt, method = "ML")
RE3.dt <- rma.mv(yi = Main_effect, V = variance, 
                 random = list(~1 | StudyID, ~1 | Effect_size_ID,~1 | Species,~1 | Country), 
                 data = dt, method = "ML")
RE4.dt <- rma.mv(yi = Main_effect, V = variance, 
                 random = list(~1 | StudyID, ~1 | Effect_size_ID,~1 | Shared_first_author,~1 | Country), 
                 data = dt, method = "ML")

RE5.dt <- rma.mv(yi = Main_effect, V = variance, 
                 random = list(~1 | StudyID, ~1 | Effect_size_ID,~1 | Shared_first_author), 
                 data = dt, method = "ML")
RE6.dt <- rma.mv(yi = Main_effect, V = variance, 
                 random = list(~1 | StudyID, ~1 | Effect_size_ID,~1 | Country), 
                 data = dt, method = "ML")
RE7.dt <- rma.mv(yi = Main_effect, V = variance, 
                 random = list(~1 | StudyID, ~1 | Effect_size_ID,~1 | Species), 
                 data = dt, method = "ML")
RE8.dt <- rma.mv(yi = Main_effect, V = variance, random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                 data = dt, method = "ML")
AIC(RE1.dt,RE2.dt,RE3.dt,RE4.dt,RE5.dt,RE6.dt,RE7.dt,RE8.dt)
```


## Results corresponding to Fig 2
```{r}
##### FIG 2 overall OA,OW,and interaction effects on marine trophic levels----
# Predator unmerged using the moderator "TrophicLevel"
V_0.5 <- make_VCV_matrix(data = dt, V = "variance",cluster = "share_organism", 
                         obs = "Effect_size_ID", type = "vcv", rho = 0.5)

str_TL <- rma.mv(yi = Main_effect, V = V_0.5, mods = ~Stressor*TrophicLevel-1,random = list(~1 | StudyID, ~1 | Effect_size_ID), 
              data = dt, method = "REML")

# Predator merged using the moderator "Trophic_level"
str_tl=rma.mv(yi = Main_effect, V = V_0.5, mods = ~Stressor*Trophic_level-1,
              random = list(~1 | StudyID, ~1 | Effect_size_ID), 
              data = dt, method = "REML")


# I guess 

orchard_plot(str_tl, mod = "Stressor", group = "StudyID",
             trunk.size = 0.1, xlab = "Effect size (lnRR)")

orchard_plot(str_tl, mod = "Trophic_level", group = "StudyID",
             trunk.size = 0.1, xlab = "Effect size (lnRR)")

##

dt$Stressor_TrophicLevel <- paste(dt$Stressor, dt$TrophicLevel, sep = "\n")

str_tl2=rma.mv(yi = Main_effect, V = V_0.5, mods = ~Stressor_TrophicLevel,random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dt, method = "REML")

p_str_tl2 <- orchard_plot(str_tl2, mod = "Stressor_TrophicLevel", group = "StudyID",
             trunk.size = 0.1, xlab = "Effect size (lnRR)", angle = 45)

p_str_tl2
```

## Results corresponding to Fig 3

```{r}
##### FIG 3A Effects on calcifiers at different trophic levels----
## calcifiers
# unmerged predators

# I realise that if people use subset argument in metafor - orchard does not run 
# I need to fix it 

dat1 <- subset(dt, Calcifier=='y')

calstr_TL=rma.mv(yi = Main_effect, V = V_0.5, mods = ~Stressor*TrophicLevel-1,
                 random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                 data = dt, method = "REML")
summary(calstr_TL)

# note calstr_TL & calstr_TL are the same 
V_0.5b <- make_VCV_matrix(data = dat1, V = "variance",cluster = "share_organism", 
                         obs = "Effect_size_ID", type = "vcv", rho = 0.5)

calstr_TL2 =rma.mv(yi = Main_effect, V = V_0.5b, mods = ~Stressor_TrophicLevel-1,
                 random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                 data = dat1, method = "REML")

summary(calstr_TL2)

p_calstr_TL2 <- orchard_plot(calstr_TL2, mod = "Stressor_TrophicLevel", 
                             group = "StudyID", trunk.size = 0.1, 
                             xlab = "Effect size (lnRR)", angle = 45)

p_calstr_TL2

# Merged
calstr_tl=rma.mv(yi = Main_effect, V = V_0.5b, mods = ~Stressor_TrophicLevel-1,
                 #subset=(Calcifier=='y'),
                 random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                 data = dat1, method = "REML")

p_calstr_tl <- orchard_plot(calstr_tl, mod = "Stressor_TrophicLevel", 
                             group = "StudyID", trunk.size = 0.1, 
                             xlab = "Effect size (lnRR)", angle = 45)

p_calstr_tl
##### FIG 3B Effects on non-calcifiers at different trophic levels----
## non-calcifiers
# Unmerged
ncalstr_TL=rma.mv(yi = Main_effect, V = V_0.5b, mods = ~Stressor_TrophicLevel-1,
                  #subset=(Calcifier=='n'),
                  random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                  data = dat1, method = "REML")

p_ncalstr_TL <- orchard_plot(ncalstr_TL, mod = "Stressor_TrophicLevel", 
                             group = "StudyID", trunk.size = 0.1, 
                             xlab = "Effect size (lnRR)", angle = 45)

p_ncalstr_TL

# Merged
ncalstr_tl=rma.mv(yi = Main_effect, V = V_0.5b, mods = ~Stressor_TrophicLevel-1,
                  #subset=(Calcifier=='n'),
                  random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                  data = dat1, method = "REML")

p_ncalstr_tl <- orchard_plot(ncalstr_tl, mod = "Stressor_TrophicLevel", 
                             group = "StudyID", trunk.size = 0.1, 
                             xlab = "Effect size (lnRR)", angle = 45)

p_ncalstr_tl

noncalstre <- rma.mv(yi = Main_effect, V = V_0.5b, mods = ~Stressor-1,
                     #subset=(Calcifier=='n'),
                     random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                     data = dat1, method = "REML")

p_noncalstre <- orchard_plot(noncalstre, mod = "Stressor", 
                             group = "StudyID", trunk.size = 0.1, 
                              trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_noncalstre

```

## Results corresponding to Fig 5

```{r}
##### FIG 5 Effects on climate regions----
tropic <- filter(dt, Region2=='Tropical')
V_0.5_tropic <- make_VCV_matrix(data = tropic, V = "variance",cluster = "share_organism",
                                obs = "Effect_size_ID", type = "vcv", rho = 0.5) 
tropic_model <- rma.mv(yi = Main_effect, V = V_0.5_tropic, mods = ~Stressor-1,random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                       data = tropic, method = "REML")

p_tropic <- orchard_plot(tropic_model, mod = "Stressor", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_tropic

sub_tropic <- filter(dt, Region2=='Sub-tropical')
V_0.5_sub_tropical <- make_VCV_matrix(data = sub_tropic, V = "variance",cluster = "share_organism", 
                                      obs = "Effect_size_ID", type = "vcv", rho = 0.5) 
sub_t_model <- rma.mv(yi = Main_effect, V = V_0.5_sub_tropical, mods = ~Stressor-1,random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                      data = sub_tropic, method = "REML")

p_sub_t <- orchard_plot(sub_t_model, mod = "Stressor", group = "StudyID",
                        trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_sub_t

temperate <- filter(dt, Region2=='Temperate')

V_0.5_temperate <- make_VCV_matrix(data = temperate, V = "variance",cluster = "share_organism", 
                                   obs = "Effect_size_ID", type = "vcv", rho = 0.5) 
temperate_model <- rma.mv(yi = Main_effect, V = V_0.5_temperate, mods = ~Stressor-1,random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                          data = temperate, method = "REML")

p_temperate <- orchard_plot(temperate_model, mod = "Stressor", group = "StudyID",
                            trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_temperate

```


# Re-analysis

## Data

```{r}
dt=read.csv(here("dat", 'OAW_interaction.csv'))

# only select variables that are relevant to the meta-analytic modelling
dt2 <- select(dt, StudyID, Year, Latitude, Longitude, Abs_lat, Region, Region2, Duration, Stressor, Calcifier, BiologicalResponses, TrophicLevel, Trophic_level, LifeStage, share_organism, Nc, Ne, Xc, Xe, Sc, Se)
#dt2 <- dt[,1:35]
#which(colnames(dt2)%in%(c("Effect_size_ID", "Factor")))
#dt2 <- dt2[, -c(6,16)]
# convert it into a wide format so that we can calculate different types of effect sizes
dt_wide <- pivot_wider(dt2, names_from = Stressor,
                       values_from = c(Ne, Xe, Se),
                       names_sep ="_")
# add ob ID
dt_wide$Effect_size_ID <- 1:nrow(dt_wide)
```

## Effect size computation

```{r}
# 'Focal' effect_size 
effect_size <- with(dt_wide, mapply(effect_set, 
                      CC_n = Nc,
                      CC_mean = Xc, 
                      CC_SD = Sc,
                      EC_n = Ne_OA, 
                      EC_mean = Xe_OA, 
                      EC_SD = Se_OA,
                      CS_n = Ne_OW, 
                      CS_mean = Xe_OW, 
                      CS_SD = Se_OW,
                      ES_n = Ne_interaction, 
                      ES_mean = Xe_interaction, 
                      ES_SD = Se_interaction,
                      percent = "no",
                      SIMPLIFY = FALSE
                      ))
effect_size <- map_dfr(effect_size, I)

# 'Pairwise' effect size
effect_size2 <- with(dt_wide, mapply(effect_set2, 
                      CC_n = Nc,
                      CC_mean = Xc, 
                      CC_SD = Sc,
                      EC_n = Ne_OA, 
                      EC_mean = Xe_OA, 
                      EC_SD = Se_OA,
                      CS_n = Ne_OW, 
                      CS_mean = Xe_OW, 
                      CS_SD = Se_OW,
                      ES_n = Ne_interaction, 
                      ES_mean = Xe_interaction, 
                      ES_SD = Se_interaction,
                      percent = "no",
                      SIMPLIFY = FALSE))

effect_size2 <- map_dfr(effect_size2, I)


# remove NA
full_info <- which(complete.cases(effect_size) == TRUE)
dat <- bind_cols(dt_wide, effect_size, effect_size2)
dat <- dat[full_info, ]

# remove Inf and -Inf
dat <- dat[!is.infinite(dat$lnRR_E) & !is.infinite(dat$lnRRV_E) &
             !is.infinite(dat$lnRR_S) & !is.infinite(dat$lnRRV_S) &
             !is.infinite(dat$lnRR_ES) & !is.infinite(dat$lnRRV_ES) &
             !is.infinite(dat$SMD_E) & !is.infinite(dat$SMDV_E) &
             !is.infinite(dat$SMD_S) & !is.infinite(dat$SMDV_S) &
             !is.infinite(dat$SMD_ES) & !is.infinite(dat$SMDV_ES), ]
```


## Statistical issue 1

The original authors mixed up effect sizes for different main effects and the interaction, and used a meta-regression to estimate the mean effects of different main effects and the interaction. This is both statistically and biologically wrong. 

### Meta-regression allowing heteroscedasticity

A meta-regression model used by the original authors assumes homoscedasticity, which means the variances of the two main effects and interaction are assumed to be the same. However, the empirical distribution of the effect sizes of the two main effects and interaction, as shown in Figure 2, clearly shows that two main effects and interaction have unequal variances. A tentative approach is to use multivariate meta-analysis model. 

However, the results based on multivariate approach indicate that there were no main effects and interaction


```{r}
# multivariate approach allowing heterogeneity to differ across different levels of a predictor
V_0.5 <- metafor::vcalc(vi = variance, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = dt)

str_TL_mv0.5 <- rma.mv(yi = Main_effect, 
                   V = V_0.5, 
                   mods = ~Stressor - 1, 
                   random = list(~ Stressor | StudyID, ~ Stressor | Effect_size_ID), 
                   struct = "DIAG",
                   data = dt, method = "REML")

str_TL_mv0.5_r <- robust(str_TL_mv0.5, cluster = dt$StudyID)
summary(str_TL_mv0.5_r)
# use LRT to test whether variance components significantly differ across different levels of stressor
str_TL_mv0.50 <- update(str_TL_mv0.5, struct="ID")
anova(str_TL_mv0.50, str_TL_mv0.5)

p_str_TL_mv0.5 <- orchard_plot(str_TL_mv0.5, mod = "Stressor", group = "StudyID",
                               trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_str_TL_mv0.5

# given multivariate approach is sensitive to the assumed sampling correlation, we assume different values of sampling correlation to check the robustness of the model results
## a higher correlation
V_0.9 <- metafor::vcalc(vi = variance, cluster = share_organism, obs = Effect_size_ID, rho = 0.9, data = dt)


str_TL_mv0.9 <- rma.mv(yi = Main_effect, 
                   V = V_0.9, 
                   mods = ~Stressor - 1, 
                   random = list(~ Stressor | StudyID), 
                   struct = "DIAG",
                   data = dt, method = "REML")

p_str_TL_mv0.9 <- orchard_plot(str_TL_mv0.9, mod = "Stressor", group = "StudyID",
                               trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_str_TL_mv0.9

## a lower correlation
V_0.2 <- metafor::vcalc(vi = variance, cluster = share_organism, obs = Effect_size_ID, rho = 0.2, data = dt)

str_TL_mv0.2 <- rma.mv(yi = Main_effect, 
                   V = V_0.2, 
                   mods = ~Stressor - 1, 
                   random = list(~ Stressor | StudyID), 
                   struct = "DIAG",
                   data = dt, method = "REML")

summary(str_TL_mv0.2)
str_TL_mv0.2r <-  robust(str_TL_mv0.2, cluster = dt$StudyID)
summary(str_TL_mv0.2r)

p_str_TL_mv0.2 <- orchard_plot(str_TL_mv0.2, mod = "Stressor", group = "StudyID",
                               trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_str_TL_mv0.2


```

### Separate analysis of two main effects and their interaction

Biologically, two main effects and their interaction represent three different biological processes of marine ecosystem's response to stressors, they cannot be jointly synthesized. The average effects across two main effects and their interaction is meaningless and joint synthesis of them creates artifact heterogeneity. A approach is to separately analyse each of the two main effects and their interaction. 

However, results based on this proper approach indicate that main effect 2 (OW) was zero.

```{r}
# main effect 1 - OA
## lnRR
## VCV
V_0.5_E <- metafor::vcalc(vi = lnRRV_E, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = dat)
## estimates of main effect1
str_TL_E <- rma.mv(yi = lnRR_E, V = V_0.5_E, random = list(~1 | StudyID, ~1 | Effect_size_ID), 
                   data = dat, method = "REML")

p_str_TL_E <- orchard_plot(str_TL_E, mod = "1", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_str_TL_E

## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnRR_E, V = V_0.5_E, mods = ~ TrophicLevel - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

## estimates of different Calcifier - fig 3
rma.mv(yi = lnRR_E, V = V_0.5_E, mods = ~ Calcifier - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

## estimates of different Region2 - fig 5
rma.mv(yi = lnRR_E, V = V_0.5_E, mods = ~ Region2 - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

# main effect 2 - OW
# lnRR
## VCV
V_0.5_S <- metafor::vcalc(vi = lnRRV_S, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = dat)
## estimates of main effect2
str_TL_S <- rma.mv(yi = lnRR_S, V = V_0.5_S, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_str_TL_S <- orchard_plot(str_TL_S, mod = "1", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_str_TL_S

## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnRR_S, V = V_0.5_S, mods = ~ TrophicLevel - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")
## estimates of different Calcifier - fig 3
rma.mv(yi = lnRR_S, V = V_0.5_S, mods = ~ Calcifier - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")
## estimates of different Region2 - fig 5
rma.mv(yi = lnRR_S, V = V_0.5_S, mods = ~ Region2 - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")


# interaction
# lnRR
# VCV
V_0.5_ES <- metafor::vcalc(vi = lnRRV_ES, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = dat)
## estimates of interaction
str_TL_ES <- rma.mv(yi = lnRR_ES, V = V_0.5_ES, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_str_TL_ES <- orchard_plot(str_TL_ES, mod = "1", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (lnRR)", flip = FALSE)

p_str_TL_ES

## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnRR_ES, V = V_0.5_ES, mods = ~ TrophicLevel - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")
## estimates of different Calcifier - fig 3
rma.mv(yi = lnRR_ES, V = V_0.5_ES, mods = ~ Calcifier - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")
## estimates of different Region2 - fig 5
rma.mv(yi = lnRR_ES, V = V_0.5_ES, mods = ~ Region2 - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")
```




## Statistical issue 2

The main effects and their interaction depends on the scale of the effect. The original author used measured the main effects and their interaction at the multiplicative scale (lnRR). However, using additive scale (SMD) to measure the main effects and their interaction leads to different conclusions.

```{r}
# main effect 1 - OA
## SMD
## VCV
V_0.5_E <- metafor::vcalc(vi = SMDV_E, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = dat)
## estimates of main effect1
str_TL_E2 <- rma.mv(yi = SMD_E, V = V_0.5_E, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_str_TL_E2 <- orchard_plot(str_TL_E2, mod = "1", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_str_TL_E2

## estimates of different TrophicLevel - fig 2
mod_fig2_E <- rma.mv(yi = SMD_E, V = V_0.5_E, mods = ~ TrophicLevel - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig2_E <- orchard_plot(mod_fig2_E, mod = "TrophicLevel", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig2_E

## estimates of different Calcifier - fig 3
mod_fig3_E <- rma.mv(yi = SMD_E, V = V_0.5_E, mods = ~ Calcifier - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig3_E <- orchard_plot(mod_fig3_E, mod = "Calcifier", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig3_E

## estimates of different Region2 - fig 5
mod_fig5_E <- rma.mv(yi = SMD_E, V = V_0.5_E, mods = ~ Region2 - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig5_E <- orchard_plot(mod_fig5_E, mod = "Region2", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig5_E


# main effect 2 - OW
# SMD
## VCV
V_0.5_S <- metafor::vcalc(vi = SMDV_S, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = dat)
## estimates of main effect2
str_TL_S2 <- rma.mv(yi = SMD_S, V = V_0.5_S, 
                    random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_str_TL_S2 <- orchard_plot(str_TL_S2, mod = "1", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_str_TL_S2

## estimates of different TrophicLevel - fig 2
mod_fig2_S <- rma.mv(yi = SMD_S, V = V_0.5_S, mods = ~ TrophicLevel - 1, 
                     random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig2_S <- orchard_plot(mod_fig2_S, mod = "TrophicLevel", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig2_S
## estimates of different Calcifier - fig 3
mod_fig3_S <-rma.mv(yi = SMD_S, V = V_0.5_S, mods = ~ Calcifier - 1, 
                    random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig3_S <- orchard_plot(mod_fig3_S, mod = "Calcifier", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig3_S
## estimates of different Region2 - fig 5
mod_fig5_S <-rma.mv(yi = SMD_S, V = V_0.5_S, mods = ~ Region2 - 1, 
                    random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig5_S <- orchard_plot(mod_fig5_S, mod = "Region2", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig5_S

# interaction
# SMD
# VCV
V_0.5_ES <- metafor::vcalc(vi = SMDV_ES, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = dat)
## estimates of interaction
str_TL_ES2 <- rma.mv(yi = SMD_ES, V = V_0.5_ES, 
                     random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_str_TL_ES2 <- orchard_plot(str_TL_ES2, mod = "1", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_str_TL_ES2

## estimates of different TrophicLevel - fig 2
mod_fig2_ES <-rma.mv(yi = SMD_ES, V = V_0.5_ES, mods = ~ TrophicLevel - 1, 
                     random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig2_ES <- orchard_plot(mod_fig2_ES, mod = "TrophicLevel", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig2_ES


## estimates of different Calcifier - fig 3
mod_fig3_ES <-rma.mv(yi = SMD_ES, V = V_0.5_ES, mods = ~ Calcifier - 1, 
                     random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig3_ES <- orchard_plot(mod_fig3_ES, mod = "Calcifier", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig3_ES
## estimates of different Region2 - fig 5
mod_fig5_ES <- rma.mv(yi = SMD_ES, V = V_0.5_ES, mods = ~ Region2 - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = dat, method = "REML")

p_mod_fig5_ES <- orchard_plot(mod_fig5_ES, mod = "Region2", group = "StudyID",
                          trunk.size = 0.3, branch.size = 2,
                            xlab = "Effect size (SMD)", flip = FALSE)

p_mod_fig5_ES
```

## Statistical issue 3

The mean effects produced from a meta-analysis cannot be properly interpreted without an analysis of heterogeneity, or inconsistency, among
effect sizes. The original author did not report heterogeneity statistics. Average effect sizes with high heterogeneity have questionable meaning. While meta-analysis of a set of similar experiments on a single species has a clear interpretation, interpreting a meta-effect across species and biogeographic contexts may be questionable. While average effects are often assumed to yield generalities, averages of highly heterogeneous effect sizes are neither generalizable nor transferable by themselves.

```{r}
# I2
i2_ml(str_TL_ES)
i2_ml(str_TL_E)
i2_ml(str_TL_S)
# CV
cv_ml(str_TL_ES)
cv_ml(str_TL_E)
cv_ml(str_TL_S)
# PI
mod_results(str_TL_ES, group = "StudyID", data = dat)
mod_results(str_TL_E, group = "StudyID", data = dat)
mod_results(str_TL_S, group = "StudyID", data = dat)

# PD
propT_beyond(pred_dist_data(str_TL_ES), df = str_TL_ES$QEdf, threshold = str_TL_ES$ci.lb, tail = "below")
propT_beyond(pred_dist_data(str_TL_E), df = str_TL_E$QEdf, threshold = str_TL_E$ci.lb, tail = "below")
propT_beyond(pred_dist_data(str_TL_S), df = str_TL_S$QEdf, threshold = str_TL_S$ci.lb, tail = "below")
```


## Statistical issue 4

The power to detect interactive effects between multiple stressors is extremely low. Primary studies also have large Type M and Type S errors. The original author counted the percentage of different types of interaction effects (additive, antagonistic, and synergistic). Given the high sign errors of the primary studies, it is meaningless to count the percentage of different types of interaction effects.

```{r}
#-----------power-----------#
# meta-analysis level
## main effect 1
power.ma_Shinichi(mu=str_TL_E$beta[1],SE=str_TL_E$se[1])
## main effect 2
power.ma_Shinichi(mu=str_TL_S$beta[1],SE=str_TL_S$se[1])
## interaction
power.ma_Shinichi(mu=str_TL_ES$beta[1],SE=str_TL_ES$se[1])


#individual study level
## main effect 1
dat <- dat %>% mutate(pwr_E = power.individual_Shinichi(mu = str_TL_E$beta[1], se = sqrt(lnRRV_E)))

## main effect 2
dat <- dat %>% mutate(pwr_S = power.individual_Shinichi(mu = str_TL_S$beta[1], se = sqrt(lnRRV_S)))

## interaction
dat <- dat %>% mutate(pwr_ES = power.individual_Shinichi(mu = str_TL_ES$beta[1], se = sqrt(lnRRV_ES)))

#-----------Type S-----------#
# meta-analysis level
## main effect 1
error_S(mu=str_TL_E$beta[1],se=str_TL_E$se[1])
## main effect 2
error_S(mu=str_TL_S$beta[1],se=str_TL_S$se[1])
## interaction
error_S(mu=str_TL_ES$beta[1],se=str_TL_ES$se[1])

#individual study level
## main effect 1
S_E <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  S_E[i] <- error_S(mu = str_TL_E$beta[1], se = sqrt(dat$lnRRV_E)[i])
}
dat$S_E <- S_E

## main effect 2
S_S <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  S_S[i] <- error_S(mu = str_TL_S$beta[1], se = sqrt(dat$lnRRV_S)[i])
}
dat$S_S <- S_S


## interaction
S_ES <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  S_ES[i] <- error_S(mu = str_TL_ES$beta[1], se = sqrt(dat$lnRRV_ES)[i])
}
dat$S_ES <- S_ES


#-----------Type M-----------#
# meta-analysis level
## main effect 1
error_M(mu=str_TL_E$beta[1],se=str_TL_E$se[1])
## main effect 2
error_M(mu=str_TL_S$beta[1],se=str_TL_S$se[1])
## interaction
error_M(mu=str_TL_ES$beta[1],se=str_TL_ES$se[1])

#individual study level
## main effect 1
M_E <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  M_E[i] <- error_M(mu = str_TL_E$beta[1], se = sqrt(dat$lnRRV_E)[i])
}
dat$M_E <- M_E

## main effect 2
M_S <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  M_S[i] <- error_M(mu = str_TL_S$beta[1], se = sqrt(dat$lnRRV_S)[i])
}
dat$M_S <- M_S


## interaction
M_ES <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  M_ES[i] <- error_M(mu = str_TL_ES$beta[1], se = sqrt(dat$lnRRV_ES)[i])
}
dat$M_ES <- M_ES
```



## Bonus

Biologically, the effects of multiple stressors are beyond mean. Using a new set of effect size measures, we found OA could increase the among-individual variability. This has important evolutionary implication that individuals do not have a consistent response to the negative impact of OA - some individuals can buffer the negative impact from OA and can survive, while others cannot.

```{r}
# 'Focal' effect_size 
effect_sizeV <- with(dt_wide, mapply(effect_setV, 
                      CC_n = Nc,
                      CC_mean = Xc, 
                      CC_SD = Sc,
                      EC_n = Ne_OA, 
                      EC_mean = Xe_OA, 
                      EC_SD = Se_OA,
                      CS_n = Ne_OW, 
                      CS_mean = Xe_OW, 
                      CS_SD = Se_OW,
                      ES_n = Ne_interaction, 
                      ES_mean = Xe_interaction, 
                      ES_SD = Se_interaction,
                      percent = "no",
                      SIMPLIFY = FALSE
                      ))
effect_sizeV <- map_dfr(effect_sizeV, I)

# remove NA
full_info <- which(complete.cases(effect_sizeV) == TRUE)
# binding data
datV <- bind_cols(dt_wide, effect_sizeV)
datV <- datV[full_info, ]
# remove Inf and -Inf values in specified columns
datV <- datV[!is.infinite(datV$lnVRV_E) & !is.infinite(datV$lnVR_S) & !is.infinite(datV$lnVRV_S) &
             !is.infinite(datV$lnVR_ES) & !is.infinite(datV$lnVRV_ES) & !is.infinite(datV$lnCVR_E) &
             !is.infinite(datV$lnCVRV_E) & !is.infinite(datV$lnCVR_S) & !is.infinite(datV$lnCVRV_S) &
             !is.infinite(datV$lnCVR_ES) & !is.infinite(datV$lnCVRV_ES), ]


# main effect 1 - OA
## lnVR
## VCV
V_0.5_E <- metafor::vcalc(vi = lnVRV_E, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = datV)
## estimates of main effect1
str_TL_V_E <- rma.mv(yi = lnVR_E, V = V_0.5_E, 
                     random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_E <- orchard_plot(str_TL_V_E, group = "StudyID", xlab = "lnVR (effect size)",
                            trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_E
## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnVR_E, V = V_0.5_E, mods = ~TrophicLevel - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
## estimates of different Calcifier - fig 3
rma.mv(yi = lnVR_E, V = V_0.5_E, mods = ~Calcifier - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
## estimates of different Region2 - fig 5
rma.mv(yi = lnVR_E, V = V_0.5_E, mods = ~Region2 - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
## lnCVR
## VCV
V_0.5_E2 <- metafor::vcalc(vi = lnCVRV_E, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = datV)
## estimates of main effect1
str_TL_V_E2 <- rma.mv(yi = lnCVR_E, V = V_0.5_E2, 
                      random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_E2 <- orchard_plot(str_TL_V_E2, group = "StudyID", xlab = "lnVR (effect size)",
                            trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_E2
## estimates of different TrophicLevel - fig 2
str_TL_V_E2a<- rma.mv(yi = lnCVR_E, V = V_0.5_E2, mods = ~ TrophicLevel - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_E2a <- orchard_plot(str_TL_V_E2a, mod = "TrophicLevel", group = "StudyID", xlab = "lnVR (effect size)", trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_E2a

## estimates of different Calcifier - fig 3
str_TL_V_E2b <- rma.mv(yi = lnCVR_E, V = V_0.5_E2, mods = ~ Calcifier - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_E2b <- orchard_plot(str_TL_V_E2b, mod = "Calcifier", group = "StudyID", xlab = "lnVR (effect size)", trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_E2b

## estimates of different Region2 - fig 5
str_TL_V_E2c <- rma.mv(yi = lnCVR_E, V = V_0.5_E2, mods = ~ Region2 - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_E2c <- orchard_plot(str_TL_V_E2c, mod = "Region2", group = "StudyID", xlab = "lnVR (effect size)", trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_E2c


# S
# lnVR
## VCV
V_0.5_S <- metafor::vcalc(vi = lnVRV_S, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = datV)
## estimates of main effect2
str_TL_V_S <- rma.mv(yi = lnVR_S, V = V_0.5_S, 
                     random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_S <- orchard_plot(str_TL_V_S, group = "StudyID", xlab = "lnVR (effect size)",
                            trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_S

## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnVR_S, V = V_0.5_S, mods = ~ TrophicLevel - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

## estimates of different Calcifier - fig 3
rma.mv(yi = lnVR_S, V = V_0.5_S, mods = ~ Calcifier - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

## estimates of different Region2 - fig 5
rma.mv(yi = lnVR_S, V = V_0.5_S, mods = ~ Region2 - 1, random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

# lnCVR
## VCV
V_0.5_S2 <- metafor::vcalc(vi = lnCVRV_S, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = datV)
## estimates of main effect2
str_TL_V_S2 <- rma.mv(yi = lnCVR_S, V = V_0.5_S2, 
                      random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
robust(str_TL_V_S2,cluster = StudyID, clubSandwich = T)

p_str_TL_V_S2 <- orchard_plot(str_TL_V_S2, group = "StudyID", xlab = "lnVR (effect size)",
                            trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_S2

## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnCVR_S, V = V_0.5_S2, mods = ~ TrophicLevel - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
## estimates of different Calcifier - fig 3
rma.mv(yi = lnCVR_S, V = V_0.5_S2, mods = ~ Calcifier - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

## estimates of different Region2 - fig 5
rma.mv(yi = lnCVR_S, V = V_0.5_S2, mods = ~ Region2 - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

# ES
# lnVR
# VCV
V_0.5_ES <- metafor::vcalc(vi = lnVRV_ES, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = datV)
## estimates of interaction
str_TL_V_ES <- rma.mv(yi = lnVR_ES, V = V_0.5_ES, 
                      random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_ES <- orchard_plot(str_TL_V_ES, group = "StudyID", xlab = "lnVR (effect size)",
                            trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_ES
## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnVR_ES, V = V_0.5_ES, mods = ~ TrophicLevel - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
## estimates of different Calcifier - fig 3
rma.mv(yi = lnVR_ES, V = V_0.5_ES, mods = ~ Calcifier - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

## estimates of different Region2 - fig 5
rma.mv(yi = lnVR_ES, V = V_0.5_ES, mods = ~ Region2 - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")


# lnCVR
# VCV
V_0.5_ES2 <- metafor::vcalc(vi = lnCVRV_ES, cluster = share_organism, obs = Effect_size_ID, rho = 0.5, data = datV)
## estimates of their interaction
str_TL_V_ES2 <- rma.mv(yi = lnCVR_ES, V = V_0.5_ES2, 
                       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")

p_str_TL_V_ES2 <- orchard_plot(str_TL_V_ES2, group = "StudyID", xlab = "lnVR (effect size)",
                            trunk.size = 0.3, branch.size = 2, flip = FALSE)

p_str_TL_V_ES2

## estimates of different TrophicLevel - fig 2
rma.mv(yi = lnCVR_ES, V = V_0.5_ES2, mods = ~ TrophicLevel - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
## estimates of different Calcifier - fig 3
rma.mv(yi = lnCVR_ES, V = V_0.5_ES2, mods = ~ Calcifier - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
## estimates of different Region2 - fig 5
rma.mv(yi = lnCVR_ES, V = V_0.5_ES2, mods = ~ Region2 - 1, 
       random = list(~1 | StudyID, ~1 | Effect_size_ID), data = datV, method = "REML")
```

